define(["jquery","BaseView","backbone","underscore","widgets/alertMsg","widgets/clearInput"],function(e,t,n,r,i,s){"use strict";var o=t.extend({timer:null,customRule:null,next:null,submitBtn:null,checkInput:null,preValue:null,timeouts:[],events:{'change select[required="required"]:visible':"validating",'focus input[required="required"]:visible':"startValidating",'focusout input[required="required"]:visible':"stopValidating","click .validateBeforeSubmit":"validateBeforeSubmit"},initialize:function(t){this.next=t.next,this.alertMsg=new i,this.customRule=t.customRule,this.checkInput=t.checkInput,this.clearInput=new s({el:this.$el}),document.addEventListener("invalid",function(e){e.preventDefault()},!0)},validating:function(r){var i=this.validateFields(this.$('input[required="required"]:visible'),this.$('select[required="required"]:visible'),r),s=e(this.checkInput);this.next&&this.next(i),this.checkInput&&this.preValue!==s.val()&&(this.preValue=s.val(),s.parent().removeClass("hasError"),this.validateFields(this.checkInput)&&n.trigger("inputValid"))},validateBeforeSubmit:function(n){this.$(".alertMsg").remove();var r=this.$("textarea[required]:visible, input[required]:visible"),i=this.$("select[required]:visible"),s=this.validateFields(r,i);return s?!0:(n&&(n.preventDefault(),n.stopPropagation()),setTimeout(e.proxy(function(){this.validateFields(r,i,!0,!0),this.trackErrors(r,i)},this),100),!1)},trackErrors:function(r,i){var s=r.add(i),o;s.each(e.proxy(function(t,r){o=e(r).parent(".hasError"),o&&o.length>0&&n.trigger("trackError",{message:e(r).siblings(".help-error").text(),fieldId:r.id})},this))},validateTimer:function(){this.validating(),this.timeouts.push(setTimeout(e.proxy(function(){this.validateTimer()},this),300))},startValidating:function(){this.validateTimer()},stopValidating:function(){var n=e(this.checkInput).parent(),r;this.trimInput(),setTimeout(e.proxy(function(){this.validating(!0)},this),50),n.hasClass("hasError")&&setTimeout(function(){n.addClass("hasError")},0);for(r=0;r<this.timeouts.length;r++)clearTimeout(this.timeouts[r])},validateFields:function(n,i,s,o){var u=!0;return i&&i.each(function(){e(this).parent().parent().removeClass("hasError"),e(this).val()==="-1"&&(u=!1,o&&e(this).parent().parent().addClass("hasError"))}),n.each(r.bind(function(t,n){var r=e(n),i=r.parent(),a=i.find(".help-error"),f;r.val()?i.hasClass("hasError")?u=!1:(f=e.trim(r.val()),this.checkInputValidation(r,f)||(u=!1,o||s&&f!==""&&this.initInputErrorState(i,a)),u&&this.removeInputErrorState(i,a)):(u=!1,i.removeClass("hasError"),o&&this.initInputErrorState(i))},this)),u&&this.customRule&&(u=this.customRule(u)),u},checkInputValidation:function(n,r){if(this.checkSkipValidation(n))return!0;if(!(this.checkInputPattern(n,r)&&this.checkInputDataMin(n,r)&&this.checkInputMin(n,r)&&this.checkInputMax(n,r)&&this.checkInputMaxLength(n,r)))return!1;var i=e(".nameChange").data(),s=i.country,o=i.legalentity,u="";if(s!=="TH"||o!==76||n.context.name!=="firstName"&&n.context.name!=="lastName"&&n.context.name!=="bizFirm"||!!this.isValidNameForThai(r))return!0;var a=n.parent(),f=a.siblings(".ErrorMsg").find(".requirement"),u=f[0].textContent;return this.$(".alertMsg").remove(),a.find(".help-error").removeClass("hide"),a.find(".help-error").text(u).addClass("open"),!1},isValidNameForThai:function(t){var n=new RegExp("^[a-zA-Z0-9 ^<>{}\"/|;:.,'~!?@#$%^=&*\\]\\\\()\\[¿§«»ω⊙¤°℃℉€¥£¢¡®©_+]*$");return n.test(t)},checkSkipValidation:function(t){return t.data("skip-validate")===!0},initInputErrorState:function(t,n){t.addClass("hasError"),n&&n.addClass("open")},removeInputErrorState:function(t,n){t.removeClass("hasError"),n.removeClass("open")},checkInputPattern:function(t,n){if(t.attr("pattern")){var r=new RegExp("^"+t.attr("pattern")+"$");if(!r.test(n))return!1}return!0},checkInputDataMin:function(t,n){return t.data("min")&&n.length<t.data("min")?!1:!0},getRegExp:function(t,n){var r=n||t.data("decimal-separator")||".",i={decimalSeparator:r,regexPattern:new RegExp("[^0-9\\"+r+"]","g")};return i},getRawValue:function(t,n){return parseFloat(t.replace(n.regexPattern,"").replace(n.decimalSeparator,"."))},checkInputMin:function(t,n,r){if(t.attr("min")){var i=this.getRegExp(t,r),s=this.getRawValue(n,i),o=this.getRawValue(t.attr("min"),i);if(parseFloat(s)<parseFloat(o))return!1}return!0},checkInputMax:function(t,n,r){if(t.attr("max")){var i=this.getRegExp(t,r),s=this.getRawValue(n,i),o=this.getRawValue(t.attr("max"),i);if(s>o)return!1}return!0},checkInputMaxLength:function(t,n){return t.attr("maxlength")&&n.length>t.attr("maxlength")?!1:!0},trimInput:function(){var n=this.$("input:visible");n.each(function(){var t=e(this);t.val(e.trim(t.val()))})},showError:function(t){this.$(".alertMsg").remove(),this.$el.prepend(this.alertMsg.setMessage(t).el)}});return o});